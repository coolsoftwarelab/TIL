## 안드로이드 UI 스레드

>작업을 백그라운드에서 수행하고, 결과를 UI 스레드에서 업데이트 해야한다.
- CallFromWrongThreadException : UI 스레드가 아닌 다른 스레드가 뷰를 업데이트 할 때마다 발생하는 에러
- NetworkOnMainThreadException : 자바네트워크 동작은 기본적으로 블로킹. UI 스레드에서 네트워크 작업을 수행할 때 발생하는 에러

## 스레드 생성

### CoroutineDispatcher

>코루틴 디스패처는 코루틴을 적절한 스레드에 분산시킨다.  
코틀린에서는 스레드와 스레드 풀을 만들 수 있지만 직접 액세스하거나 제어하지 않고 디스패처를 통해 제어한다.

디스패처 생성 예
```
val netDispatcher = newSingleThreadContext(name = "ServiceCall")   
```

### 디스패처에 코루틴 붙이기
>디스패처를 만들고 이 디스패처를 사용하는 코루틴을 시작할 수 있다.

#### async 코루틴 시작

`async()` : 결과 처리를 위한 목적으로 코루틴 시작. Deffered<T> 를 반환한다.
```
fun main(args: Array<String>) = runBlocking {
    val task = GlobalScope.async {
        doSomething()
    }
    task.join()
    println("Completed")
}

fun doSomething() {
    throw UnsupportedOperationException("Can't do")
}
```
```
결과
>> Process finished with exit code 0
```
결과에 출력된 예외 스택은 없으며 앱도 중단되지 않고 종료 코드는 성공적으로 실행된 것으로 나온다.

`async()` 블록 안에서 발생하는 예외는 그 결과에 첨부된다
    
예외 검증 처리가 된 `async()`
```
fun main(args: Array<String>) = runBlocking {
    val task = GlobalScope.async {
        doSomething()
    }

    task.join()
        if (task.isCancelled) {
        val exception = task.getCancellationException()
        println("Error with message: ${exception.cause}")
    } else {
        println("Success")
    }
}
```
```
결과
>> Error with message: java.lang.UnsupportedOperationException: Can't do
Process finished with exit code 0
```
이 때도 에플리케이션이 중단되진 않는다.
<br></br>

예외를 전파하기 위해 `await()`를 사용(에러 시 앱 중단)
```
val task = GlobalScope.async {
    doSomething()
}
task.await()
println("Completed")
```
```
결과
>> Caused by: java.lang.UnsupportedOperationException: Can't do
finished with non-zero exit value 1
```
에러로 인해 애플리케이션이 비정상적으로 중단되고 non-zero 값이 출력된다.

#### join() vs await()
- join() : 예외 전파 안하고 처리 가능
- await() : 단지 호출만으로도 예외가 전파됨

#### lauch 코루틴 시작
>결과를 반환하지 않는 코루틴을 시작하려면 `lauch()`를 사용해야 한다.
 
```
fun main(args: Array<String>) = runBlocking {
    val task = GlobalScope.launch {
        doSomething()
    }
    task.join()
    println("Completed")
}
```
```    
결과
>> Exception in thread "DefaultDispatcher-worker-1" java.lang.UnsupportedOperationException: Can't do
Completed
Process finished with exit code 0
```
예외가 스택에 출력되지만 실행이 중단되지 않고 main()의 실행은 완료된다.


#### 코루틴을 시작할 때 특정 디스패처 사용
    
```
fun main(args: Array<String>) = runBlocking {
    val dispatcher = newSingleThreadContext(name = "ServiceCall")
    val task = GlobalScope.launch(dispatcher) {
        printCurrentThread()
    }
    task.join()
}
    
fun printCurrentThread() {
    println("Running in thread [${Thread.currentThread().name}]")
}
```
```
결과
>> Running in thread [ServiceCall]
Process finished with exit code 0
```
    
#### 안드로이드의 Dispatcher
- Dispatchers.Main - UI와 상호작용하고 빠른 작업을 실행하기 위해서만 사용해야 한다.
- Dispatchers.IO - 디스크 또는 네트워크 I/O를 실행하도록 최적화되어 있습니다. 예를 들어 파일에서 읽거나 파일에 쓰며 네트워크 작업을 실행합니다.
- Dispatchers.Default - CPU를 많이 사용하는 작업을 실행하도록 최적화되어 있다. 예를 들어 목록을 정렬하고 JSON을 파싱

```
class ExampleClass {
    val scope = CoroutineScope(Job() + Dispatchers.Main)

    fun exampleMethod() {
        // Starts a new coroutine on Dispatchers.Main as it's the scope's default
        val job1 = scope.launch {
            // New coroutine with CoroutineName = "coroutine" (default)
        }

        // Starts a new coroutine on Dispatchers.Default
        val job2 = scope.launch(Dispatchers.Default + "BackgroundCoroutine") {
            // New coroutine with CoroutineName = "BackgroundCoroutine" (overridden)
        }
    }
}
```

### 요청 
   
    
=======    
    
기타 suspend 와 GlobalScope lauch에 대한 실험
```
suspend fun main(args: Array<String>) {
    // 1
    doSomething1()

    // 2
    val task = GlobalScope.launch {
        doSomething2()
    }

    task.join()
//    delay(5000)
    println("completed")
}

suspend fun doSomething1() = GlobalScope.launch {
    println("doSomething 1-start")
    delay(1000)
    println("doSomething 1-end")
}

suspend fun doSomething2() {
    println("doSomething 2-start")
    delay(2000)
    println("doSomething 2-end")
}

// 결과
> Task :TestKt.main()
doSomething 1-start
doSomething 2-start
doSomething 1-end
doSomething 2-end
completed

```

